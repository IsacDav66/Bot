// plugins/slut.js
// Comando para "trabajos" arriesgados/ilegales y para "pagar por servicios" a otro usuario.
// Incluye verificaci√≥n de registro.

const { getUserData, saveUserData, msToTime, pickRandom, setUserRegistrationState, clearUserRegistrationState } = require('./shared-economy');
const MONEY_SYMBOL = '$';

const COOLDOWN_SLUT_SOLO_MS = 20 * 60 * 1000; // 20 minutos

const riskyActivities = [
    {
        description: "Te infiltras en una fiesta de alta sociedad para 'socializar' con gente adinerada üç∏üíº",
        successMessage: (amount) => `¬°Tu encanto funcion√≥! Conseguiste ${MONEY_SYMBOL}${amount} en 'donaciones generosas'.`,
        failureMessage: (penalty) => `ü•Ç Te pasaste de copas y te echaron. Tuviste que pagar ${MONEY_SYMBOL}${penalty} por los da√±os.`,
        minReward: 700, maxReward: 3500, penaltyPercent: 0.4, minPenaltyFlat: 250, successChance: 0.60
    },
    {
        description: "Participas en un 'intercambio cultural' muy privado y lucrativo üòâü§´",
        successMessage: (amount) => `El 'intercambio' fue un √©xito. Obtuviste ${MONEY_SYMBOL}${amount}.`,
        failureMessage: (penalty) => `üíî Hubo un malentendido y terminaste perdiendo ${MONEY_SYMBOL}${penalty}.`,
        minReward: 1000, maxReward: 5000, penaltyPercent: 0.5, minPenaltyFlat: 400, successChance: 0.50
    },
    {
        description: "Ofreces 'servicios de consultor√≠a especializada' en un callej√≥n oscuro  alleyüåÉ",
        successMessage: (amount) => `Tu 'consultor√≠a' fue muy solicitada. Ganaste ${MONEY_SYMBOL}${amount}.`,
        failureMessage: (penalty) => `üöì ¬°Redada policial! Tuviste que pagar una fianza de ${MONEY_SYMBOL}${penalty}.`,
        minReward: 600, maxReward: 2800, penaltyPercent: 0.6, minPenaltyFlat: 300, successChance: 0.55
    },
    {
        description: "Intentas seducir a un millonario/a para obtener 'apoyo financiero' sugarüí∞",
        successMessage: (amount) => `¬°Ca√±a al anzuelo! Recibiste un generoso 'regalo' de ${MONEY_SYMBOL}${amount}.`,
        failureMessage: (penalty) => `üôÖ‚Äç‚ôÇÔ∏è Te descubrieron tus intenciones y te dejaron sin nada, adem√°s perdiste ${MONEY_SYMBOL}${penalty} en el intento.`,
        minReward: 1200, maxReward: 6000, penaltyPercent: 0.3, minPenaltyFlat: 500, successChance: 0.45
    }
];

function ensureLastSlut(user) {
    if (typeof user.lastslut !== 'number' || isNaN(user.lastslut)) {
        user.lastslut = 0;
    }
}

const execute = async (client, message, args, commandName) => {
    const senderContact = await message.getContact();
    if (!senderContact) {
        console.error(`[Slut Plugin] No se pudo obtener el contacto del remitente.`);
        try { await message.reply("‚ùå No pude identificarte. Int√©ntalo de nuevo."); } catch(e) {}
        return;
    }
    const commandSenderId = senderContact.id._serialized;
    const user = await getUserData(commandSenderId, message); // payerUser se convierte en 'user'

    if (!user) {
        console.error(`[Slut Plugin] No se pudieron obtener los datos para ${commandSenderId}`);
        try { await message.reply("‚ùå Hubo un error al obtener tus datos. Int√©ntalo de nuevo."); } catch(e) {}
        return;
    }

    // --- INICIO Bloque de Verificaci√≥n de Registro ---
    if (!user.password) {
        const currentChat = await message.getChat();
        if (!currentChat.isGroup) {
            await message.reply(" üîíComando exclusivo de grupos. Por favor, usa este comando en un grupo para iniciar tu registro o usar las funciones de econom√≠a.");
            return;
        }
        const userNameToMention = user.pushname || commandSenderId.split('@')[0];
        if (!user.phoneNumber) { // CASO A: Sin contrase√±a NI n√∫mero
            user.registration_state = 'esperando_numero_telefono';
            await saveUserData(commandSenderId, user); 
            console.log(`[Slut Plugin] Usuario ${commandSenderId} (${userNameToMention}) no tiene contrase√±a ni tel√©fono. Solicitando n√∫mero. Estado: esperando_numero_telefono.`);
            const currentPrefix = message.body.charAt(0);
            await message.reply(
                `üëã ¬°Hola @${userNameToMention}!\n\n` +
                `Para usar las funciones de econom√≠a, primero necesitamos registrar tu n√∫mero de tel√©fono.\n\n` +
                `Por favor, responde en ESTE CHAT GRUPAL con el comando:\n` +
                `*${currentPrefix}mifono +TUNUMEROCOMPLETO*\n` +
                `(Ej: ${currentPrefix}mifono +11234567890)\n\n` +
                `Tu nombre de perfil actual es: *${user.pushname || 'No detectado'}*.`,
                undefined, { mentions: [commandSenderId] }
            );
            return;
        } else { // CASO B: Tiene n√∫mero (en user.phoneNumber de la BD, para commandSenderId) PERO NO contrase√±a
            // 'user' aqu√≠ es el objeto de datos para 'commandSenderId'
            // y user.phoneNumber ya tiene el n√∫mero guardado.

            user.registration_state = 'esperando_contrase√±a_dm'; // Establecer el estado en el objeto del commandSenderId
            await saveUserData(commandSenderId, user); // Guardar el estado actualizado PARA EL commandSenderId
            
            const userNameToMention = user.pushname || commandSenderId.split('@')[0];
            // El console.log debe reflejar que el estado se guard√≥ para commandSenderId
            console.log(`[Slut Plugin] Usuario ${commandSenderId} (${userNameToMention}) tiene tel√©fono (+${user.phoneNumber}). Estado 'esperando_contrase√±a_dm' establecido para √âL MISMO (${commandSenderId}).`);

            let displayPhoneNumber = user.phoneNumber;
            if (user.phoneNumber && !String(user.phoneNumber).startsWith('+')) {
                displayPhoneNumber = `+${user.phoneNumber}`;
            }

            await message.reply(
                `üõ°Ô∏è ¬°Hola @${userNameToMention}!\n\n` +
                `Ya tenemos tu n√∫mero de tel√©fono registrado (*${displayPhoneNumber}*).\n` +
                `Ahora, para completar tu registro, te he enviado un mensaje privado (DM) a ese n√∫mero para que configures tu contrase√±a. Por favor, revisa tus DMs.`+
                `‚ÄºÔ∏èSi quieres actualizar tu numero escribe .actualizarfono +52111222333 RECUERDA INCLUIR TODO TU NUMERO Y CODIGO DE PAIS\n` ,
                undefined, { mentions: [commandSenderId] }
            );
            
            // El DM se sigue enviando al ID construido a partir del phoneNumber, lo cual est√° bien.
            const dmChatIdToSendTo = `${user.phoneNumber}@c.us`;
            const dmMessageContent = "üîë Por favor, responde a este mensaje con la contrase√±a que deseas establecer para los comandos de econom√≠a.";
            
            console.log(`[Slut Plugin DM DEBUG] Intentando enviar DM para contrase√±a.`);
            console.log(`[Slut Plugin DM DEBUG] Target para DM (construido desde phoneNumber): ${dmChatIdToSendTo}`);
            // ... (try-catch para client.sendMessage(dmChatIdToSendTo, ...)) ...
            try {
                await client.sendMessage(dmChatIdToSendTo, dmMessageContent);
                console.log(`[Slut Plugin DM SUCCESS] DM para contrase√±a enviado exitosamente a ${dmChatIdToSendTo}.`);
            } catch(dmError){
                console.error(`[Slut Plugin DM ERROR] Error EXPLICITO enviando DM para contrase√±a a ${dmChatIdToSendTo}:`, dmError);
                console.error(`[Slut Plugin DM ERROR Object Details]`, JSON.stringify(dmError, Object.getOwnPropertyNames(dmError)));
                await message.reply("‚ö†Ô∏è No pude enviarte el DM para la contrase√±a...", undefined, { mentions: [commandSenderId] });
                // Si el DM falla, el estado 'esperando_contrase√±a_dm' sigue en commandSenderId.
                // No necesitamos limpiar el estado de dmChatIdToSendTo porque no lo modificamos all√≠.
            }
            return; 
        }
    }
    // --- FIN Bloque de Verificaci√≥n de Registro ---

    // Si llegamos aqu√≠, el usuario (commandSenderId) est√° registrado (tiene contrase√±a)
    console.log(`[Slut Plugin] Usuario ${commandSenderId} (${user.pushname || 'N/A'}) est√° registrado. Procesando comando .slut.`);

    // --- L√≥gica del Comando .slut ---
    if (message.mentionedIds && message.mentionedIds.length > 0) {
        // --- Funcionalidad de Pagar a Otro Usuario ---
        const targetId = message.mentionedIds[0]; // ID del usuario mencionado
        let targetContactInfo = null;
        let initialTargetNameForDisplay;

        try {
            const contact = await client.getContactById(targetId);
            if (contact) {
                targetContactInfo = { id: contact.id._serialized || contact.id, pushname: contact.pushname, name: contact.name, number: contact.number };
                initialTargetNameForDisplay = contact.pushname || contact.name || `usuario (${targetId.split('@')[0]})`;
            } else {
                initialTargetNameForDisplay = `usuario (${targetId.split('@')[0]})`;
            }
        } catch (e) {
            initialTargetNameForDisplay = `usuario (${targetId.split('@')[0]})`;
        }
        
        const targetUser = await getUserData(targetId, targetContactInfo); // Obtener datos del objetivo, actualizando su pushname si es posible
        
        if (!targetUser) {
            console.error(`[Slut Plugin] No se pudieron obtener los datos del objetivo para ${targetId}`);
            return message.reply("‚ùå Hubo un error al obtener los datos del usuario objetivo.");
        }

        // El pushname de targetUser deber√≠a estar actualizado por la llamada anterior a getUserData
        const finalTargetName = targetUser.pushname || initialTargetNameForDisplay; 
        const payerName = user.pushname || commandSenderId.split('@')[0]; // 'user' es el pagador (commandSenderId)

        if (targetId === commandSenderId) {
            return message.reply("ü§¶ No puedes pagarte a ti mismo.");
        }

        let amountToPay;
        if (args.length > 0) { // args ya no contendr√≠a el comando ni la menci√≥n si bot.js los quita
            // Asumimos que la cantidad es el primer argumento despu√©s de la menci√≥n
            // Si args viene como ['@mencion', 'cantidad'], entonces args[0] es la menci√≥n, args[1] la cantidad
            // Si args solo tiene ['cantidad'] (porque la menci√≥n se proces√≥ antes):
            const amountArg = args.find(arg => !arg.startsWith('@')); // M√°s seguro
            if (amountArg) {
                amountToPay = parseInt(amountArg);
            }
        }


        if (isNaN(amountToPay) || amountToPay <= 0) {
            return message.reply(`‚ùì Debes especificar una cantidad v√°lida para pagar a *${finalTargetName}*. Ejemplo: \`.slut @usuario 100\``);
        }

        if (typeof user.money !== 'number' || isNaN(user.money) || user.money < amountToPay) {
            return message.reply(`üí∏ No tienes suficiente dinero en mano (${MONEY_SYMBOL}${user.money || 0}) para pagar ${MONEY_SYMBOL}${amountToPay} a *${finalTargetName}*.`);
        }

        user.money -= amountToPay;
        if (typeof targetUser.money !== 'number' || isNaN(targetUser.money)) targetUser.money = 0;
        targetUser.money += amountToPay;

        await saveUserData(commandSenderId, user);   // Guardar datos del pagador
        await saveUserData(targetId, targetUser); // Guardar datos del objetivo

        console.log(`[Slut Plugin - Pago] ${commandSenderId} (${payerName}) pag√≥ ${amountToPay} a ${targetId} (${finalTargetName}). Saldo pagador: ${user.money}, Saldo receptor: ${targetUser.money}`);

        await message.reply(`üíã *${payerName}* le ha pagado ${MONEY_SYMBOL}${amountToPay} a *${finalTargetName}* por sus 'excelentes servicios'.\n\n`+
                            `*${payerName}* ahora tiene: ${MONEY_SYMBOL}${user.money}\n`+
                            `*${finalTargetName}* ahora tiene: ${MONEY_SYMBOL}${targetUser.money}`);
        
        try {
            // Enviar DM al targetId (que es el ID serializado del contacto mencionado)
            await client.sendMessage(targetId, `ü§´ ¬°Has recibido un pago de ${MONEY_SYMBOL}${amountToPay} de *${payerName}* por tus 'servicios discretos'! Tu saldo ahora es ${MONEY_SYMBOL}${targetUser.money}.`);
        } catch (privateMsgError) {
            console.error(`[Slut Plugin - Pago] Error enviando MD de notificaci√≥n a ${targetId}:`, privateMsgError.message);
        }
        return; // Termina la ejecuci√≥n para el caso de pago
    }

    // --- Si no hay menci√≥n, se ejecuta la actividad arriesgada individual ---
    ensureLastSlut(user); // user es el commandSenderId
    const now = Date.now();
    const timeSinceLastSlut = now - (user.lastslut || 0);

    if (timeSinceLastSlut < COOLDOWN_SLUT_SOLO_MS) {
        const timeLeft = COOLDOWN_SLUT_SOLO_MS - timeSinceLastSlut;
        return message.reply(`*üíÑ Necesitas recomponerte... Espera ${msToTime(timeLeft)} para tu pr√≥xima 'cita'.*`);
    }

    const activity = pickRandom(riskyActivities);
    user.lastslut = now;

    await message.reply(`*üíã ${activity.description}...*`);
    await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 2000));

    if (Math.random() < activity.successChance) {
        const amountGained = Math.floor(Math.random() * (activity.maxReward - activity.minReward + 1)) + activity.minReward;
        if (typeof user.money !== 'number' || isNaN(user.money)) user.money = 0;
        user.money += amountGained;
        await saveUserData(commandSenderId, user);
        console.log(`[Slut Plugin - Solo] ${commandSenderId} (${user.pushname || 'N/A'}) tuvo √©xito en '${activity.description}', gan√≥ ${amountGained}. Dinero: ${user.money}`);
        return message.reply(`*ü•Ç ${activity.successMessage(amountGained)}*\nTu dinero: ${MONEY_SYMBOL}${user.money}`);
    } else {
        if (typeof user.money !== 'number' || isNaN(user.money)) user.money = 0;
        let penaltyAmount = Math.floor(user.money * activity.penaltyPercent);
        penaltyAmount = Math.max(penaltyAmount, activity.minPenaltyFlat);
        penaltyAmount = Math.min(penaltyAmount, user.money);
        user.money -= penaltyAmount;
        if (user.money < 0) user.money = 0;
        await saveUserData(commandSenderId, user);
        console.log(`[Slut Plugin - Solo] ${commandSenderId} (${user.pushname || 'N/A'}) fall√≥ en '${activity.description}', perdi√≥ ${penaltyAmount}. Dinero: ${user.money}`);
        let finalMessage = `*üí• ${activity.failureMessage(penaltyAmount)}*`;
        finalMessage += `\nTu dinero: ${MONEY_SYMBOL}${user.money}`;
        return message.reply(finalMessage);
    }
};

module.exports = {
    name: 'Actividades Especiales',
    aliases: ['slut', 'cita', 'trabajonocturno', 'pagar'],
    description: 'Realiza "trabajos" arriesgados o paga a otro usuario por sus "servicios".',
    category: 'Econom√≠a', // O 'Interacci√≥n'
    execute,
};